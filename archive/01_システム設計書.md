# システム設計書

**プロジェクト名**: ブログ記事→YouTube動画自動生成システム
**バージョン**: 1.0.0
**作成日**: 2025年11月15日
**更新日**: 2025年11月15日

---

## 📋 目次

1. [システム概要](#システム概要)
2. [設計原則](#設計原則)
3. [アーキテクチャ設計](#アーキテクチャ設計)
4. [技術スタック](#技術スタック)
5. [システム要件](#システム要件)
6. [データフロー](#データフロー)
7. [コンポーネント設計](#コンポーネント設計)
8. [制約事項](#制約事項)

---

## システム概要

### 目的

ブログ記事を入力として、本人の声でナレーションされたAIアバター動画を自動生成し、YouTubeに投稿するシステムを構築する。

### 主要機能

```yaml
コア機能:
  1. ブログ記事からYouTubeスクリプト生成
  2. 本人の声をクローンした音声生成
  3. AIアバターによるリップシンク動画生成
  4. YouTube投稿（下書き）

補助機能:
  - 生成過程のリアルタイム進捗表示
  - スクリプトの編集・確認
  - プレビュー機能
  - エラーハンドリング・リトライ
```

### ビジネス要件

```yaml
目標:
  - 週2本の動画投稿
  - 5分動画またはShorts（60秒）
  - 月額コスト: $12.9-56

運用:
  - 非エンジニアが操作可能
  - ブラウザのみで完結
  - 引き継ぎ容易
```

---

## 設計原則

本システムは以下の原則に基づいて設計されています。

### KISS原則（Keep It Simple, Stupid）

```
✅ シンプルな解決策を優先
✅ 複雑な抽象化を避ける
✅ 明確で読みやすいコード
❌ 複雑なデザインパターンの乱用
❌ 過度な抽象化レイヤー
```

### YAGNI原則（You Aren't Gonna Need It）

```
✅ 現在必要な機能のみ実装
✅ MVP（最小限の機能）でリリース
✅ ユーザーフィードバックを基に拡張
❌ 使われない設定オプション
❌ 「あると便利かも」機能
```

### DRY原則（Don't Repeat Yourself）

```
✅ 重複コードを排除
✅ 共通ロジックを関数化
✅ 設定値は一箇所で管理（config.yaml）
⚠️ ただし過度な抽象化は避ける（KISS優先）
```

### Go言語の設計思想

```
✅ モジュール分割と明確な責任分離
✅ エラーハンドリングの明示性（tuple返却）
✅ 型安全性（型ヒント必須）
✅ シンプルで読みやすいコード
✅ グローバル変数を避ける
✅ 小さな関数（20行以内目安）
```

---

## アーキテクチャ設計

### 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│          Streamlit Web UI (ブラウザ)                │
│          https://xxx.streamlit.app                  │
│                                                     │
└──────────────────┬──────────────────────────────────┘
                   │
                   │ ユーザー入力
                   │ (ブログURL, アバター選択)
                   ↓
┌─────────────────────────────────────────────────────┐
│                                                     │
│              Streamlit Application                  │
│              (app.py - エントリーポイント)          │
│                                                     │
└───────┬─────────┬─────────┬─────────┬───────────────┘
        │         │         │         │
        ↓         ↓         ↓         ↓
    ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
    │ChatGPT│ │Cartes-│ │ D-ID  │ │YouTube│
    │Module │ │ia Mod.│ │Module │ │Module │
    └───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘
        │         │         │         │
        ↓         ↓         ↓         ↓
    ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
    │OpenAI │ │Cartes-│ │ D-ID  │ │YouTube│
    │ API   │ │ia API │ │  API  │ │  API  │
    └───────┘ └───────┘ └───────┘ └───────┘
                   │
                   ↓
              ┌─────────┐
              │Cloudinary│ (音声ホスティング)
              └─────────┘
```

### レイヤー構成

```
┌─────────────────────────────────────┐
│   Presentation Layer                │
│   - app.py (Streamlit UI)           │
│   - ユーザー入力・出力               │
│   - 進捗表示・エラー表示             │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Application Layer (薄い)          │
│   - ワークフロー制御                 │
│   - エラーハンドリング               │
│   - 状態管理                         │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Domain Layer                      │
│   - modules/chatgpt.py              │
│   - modules/cartesia.py             │
│   - modules/did.py                  │
│   - modules/youtube.py              │
│   (各モジュールは独立、相互依存なし) │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Infrastructure Layer              │
│   - utils/config.py (設定管理)      │
│   - utils/logger.py (ロギング)      │
│   - utils/errors.py (エラー定義)    │
└─────────────────────────────────────┘
```

---

## 技術スタック

### フロントエンド

```yaml
Streamlit:
  - バージョン: 1.28+
  - 用途: Web UI
  - 理由:
    - Pythonのみで完結
    - 高速プロトタイピング
    - Community Cloud無料デプロイ
```

### バックエンド

```yaml
Python:
  - バージョン: 3.9+
  - 理由:
    - Streamlit標準
    - AI/ML系ライブラリ豊富
    - 型ヒント対応（3.9+）

主要ライブラリ:
  - requests: HTTP API呼び出し
  - websockets: Cartesia WebSocket接続
  - pydantic: データバリデーション（型安全性）
  - pyyaml: 設定ファイル管理
```

### 外部サービス（API）

```yaml
ChatGPT API (OpenAI):
  - 用途: ブログ記事→スクリプト変換
  - 月額: $2程度
  - モデル: gpt-4o-mini推奨

Cartesia API:
  - 用途: 音声生成（声クローン）
  - 月額: $5（Pro）
  - 文字数: 100,000文字/月

D-ID API:
  - 用途: リップシンク動画生成
  - 月額: $5.9-49（Lite/Pro）
  - 動画長: Lite=5分/月、Pro=15分/月

Cloudinary:
  - 用途: 音声ファイルホスティング
  - 月額: 無料枠
  - 容量: 25GB

YouTube Data API:
  - 用途: 動画投稿
  - 月額: 無料（クォータ内）
```

### インフラ

```yaml
Streamlit Community Cloud:
  - ホスティング: 無料
  - リソース: 1GB RAM
  - 制約:
    - 月間実行時間制限あり
    - 週2本の動画生成なら余裕

GitHub:
  - コード管理
  - Streamlit Cloudと連携
  - Private/Publicどちらも可
```

---

## システム要件

### 機能要件

#### FR-001: スクリプト生成

```yaml
概要: ブログ記事URLから YouTube スクリプトを生成
入力: ブログ記事URL
処理:
  1. URLから記事内容を取得
  2. ChatGPT APIで要約・スクリプト化
  3. 150単語以内（Shorts）または500単語（5分動画）
出力: YouTubeスクリプト（テキスト）
成功条件:
  - スクリプトが自然な日本語
  - 指定文字数以内
  - エラー時は明確なメッセージ
```

#### FR-002: 音声生成

```yaml
概要: スクリプトから本人の声で音声を生成
入力:
  - スクリプト（テキスト）
  - 声クローンID
処理:
  1. Cartesia APIに接続（WebSocket）
  2. 音声生成
  3. Cloudinaryにアップロード
出力: 音声ファイルURL
成功条件:
  - 音声が自然
  - クリアな発音
  - 適切な速度
```

#### FR-003: 動画生成

```yaml
概要: 音声からリップシンク動画を生成
入力:
  - 音声URL
  - アバター画像URL
処理:
  1. D-ID APIで動画生成リクエスト
  2. 完了まで待機（Webhook or ポーリング）
  3. 動画URL取得
出力: 動画ファイルURL
成功条件:
  - リップシンクが自然
  - 音声と映像の同期
```

#### FR-004: YouTube投稿

```yaml
概要: 生成された動画をYouTubeに投稿
入力:
  - 動画URL
  - タイトル、説明文
処理:
  1. 動画ダウンロード
  2. YouTube API で投稿（下書き）
出力: YouTube動画URL
成功条件:
  - 下書きとして投稿完了
  - URLが取得できる
```

### 非機能要件

#### NFR-001: パフォーマンス

```yaml
応答時間:
  - スクリプト生成: 30秒以内
  - 音声生成: 2分以内
  - 動画生成: 5分以内
  - 合計: 10分以内（Shorts）

スループット:
  - 同時処理: 1件（週2本想定）
```

#### NFR-002: 可用性

```yaml
稼働時間:
  - 必要時のみ起動（半自動運用）
  - Streamlit Cloud休止状態からの復帰: 10秒以内

エラー耐性:
  - API障害時の自動リトライ（3回）
  - タイムアウト処理
  - 明確なエラーメッセージ
```

#### NFR-003: セキュリティ

```yaml
APIキー管理:
  - Streamlit Secrets使用
  - コードにハードコードしない
  - .gitignoreでsecrets除外

アクセス制御:
  - オプション: パスワード認証
  - Private GitHubリポジトリ推奨
```

#### NFR-004: 保守性

```yaml
コード品質:
  - 型ヒント必須
  - Docstring必須
  - 関数は20行以内
  - テストコード

ドキュメント:
  - スクリーンショット付き運用マニュアル
  - トラブルシューティングガイド
  - API仕様書
```

#### NFR-005: 引き継ぎ容易性

```yaml
要件:
  - 非エンジニアが操作可能
  - ブラウザのみで完結
  - エラーメッセージは日本語
  - 設定ファイルにコメント付き
```

---

## データフロー

### 全体フロー

```
[1] ユーザー入力
    ↓
    - ブログURL
    - アバター画像選択
    ↓
[2] スクリプト生成（ChatGPT）
    ↓
    - ブログ記事内容取得
    - ChatGPT API呼び出し
    - スクリプト生成（150-500単語）
    ↓
[3] ユーザー確認・編集
    ↓
    - Streamlit text_area で編集可能
    - 承認して次へ
    ↓
[4] 音声生成（Cartesia）
    ↓
    - Cartesia WebSocket接続
    - 音声生成（MP3）
    - Cloudinaryアップロード
    - 音声URL取得
    ↓
[5] 動画生成（D-ID）
    ↓
    - D-ID API呼び出し
    - 動画生成（3-5分待機）
    - 動画URL取得
    ↓
[6] プレビュー確認
    ↓
    - Streamlit st.video でプレビュー
    - 承認して次へ
    ↓
[7] YouTube投稿
    ↓
    - 動画ダウンロード
    - YouTube API で投稿（下書き）
    - YouTube URL取得
    ↓
[8] 完了通知
```

### データモデル

#### VideoGenerationRequest

```python
from pydantic import BaseModel, HttpUrl
from typing import Optional

class VideoGenerationRequest(BaseModel):
    """動画生成リクエスト"""
    blog_url: HttpUrl
    avatar_image: str  # 選択されたアバター画像（プリセット）
    voice_id: str      # Cartesia声クローンID
    max_words: int = 150  # スクリプト最大単語数
```

#### GeneratedScript

```python
class GeneratedScript(BaseModel):
    """生成されたスクリプト"""
    text: str
    word_count: int
    estimated_duration_seconds: int
```

#### GeneratedAudio

```python
class GeneratedAudio(BaseModel):
    """生成された音声"""
    audio_url: HttpUrl
    duration_seconds: float
    file_size_bytes: int
```

#### GeneratedVideo

```python
class GeneratedVideo(BaseModel):
    """生成された動画"""
    video_url: HttpUrl
    duration_seconds: float
    resolution: str  # e.g., "1920x1080"
```

---

## コンポーネント設計

### ディレクトリ構造

```
blog-to-youtube/
├── app.py                    # Streamlitエントリーポイント
├── config.yaml               # 設定ファイル
├── requirements.txt          # Python依存関係
├── README.md
│
├── modules/                  # ビジネスロジック（独立モジュール）
│   ├── __init__.py
│   ├── chatgpt.py           # スクリプト生成
│   ├── cartesia.py          # 音声生成
│   ├── did.py               # 動画生成
│   └── youtube.py           # YouTube投稿
│
├── utils/                    # ユーティリティ
│   ├── __init__.py
│   ├── config.py            # 設定読み込み
│   ├── logger.py            # ロギング
│   └── errors.py            # カスタムエラー定義
│
├── models/                   # データモデル
│   ├── __init__.py
│   └── schemas.py           # Pydanticモデル
│
├── tests/                    # テスト
│   ├── test_chatgpt.py
│   ├── test_cartesia.py
│   ├── test_did.py
│   └── test_youtube.py
│
├── docs/                     # ドキュメント
│   ├── 運用マニュアル.md
│   └── トラブルシューティング.md
│
└── .streamlit/               # Streamlit設定
    ├── config.toml
    └── secrets.toml.example
```

### モジュール責務

#### modules/chatgpt.py

```python
"""
ブログ記事からYouTubeスクリプトを生成

責務:
  - ブログ記事の取得
  - ChatGPT APIでスクリプト生成
  - 文字数制御

依存:
  - OpenAI API
  - requests (HTTP)
"""
```

#### modules/cartesia.py

```python
"""
Cartesia APIで音声生成

責務:
  - WebSocket接続管理
  - 音声生成
  - Cloudinaryアップロード

依存:
  - Cartesia API
  - Cloudinary API
  - websockets
"""
```

#### modules/did.py

```python
"""
D-ID APIでリップシンク動画生成

責務:
  - 動画生成リクエスト
  - ポーリング/Webhook待機
  - 動画URL取得

依存:
  - D-ID API
  - requests (HTTP)
"""
```

#### modules/youtube.py

```python
"""
YouTube Data APIで動画投稿

責務:
  - 動画ダウンロード
  - YouTube投稿（下書き）
  - メタデータ設定

依存:
  - YouTube Data API
  - google-api-python-client
"""
```

---

## 制約事項

### 技術的制約

```yaml
Streamlit Community Cloud:
  - RAM: 1GB
  - 実行時間: 長時間処理（10分超）で切断の可能性
  - 対策: プログレスバー、定期的な状態更新

API制限:
  - Cartesia: 100,000文字/月
  - D-ID Lite: 5分動画/月
  - ChatGPT: レート制限あり
  - 対策: リトライロジック、エラーハンドリング

ファイルサイズ:
  - Cloudinary: 無料枠25GB
  - YouTube: 動画最大256GB
  - 対策: 定期的なCloudinaryクリーンアップ
```

### ビジネス制約

```yaml
コスト:
  - 月額上限: $60
  - 超過した場合のアラート必要

投稿頻度:
  - 週2本
  - D-ID Liteの場合は60秒以内必須
```

### 運用制約

```yaml
非エンジニア運用:
  - コードを触らない
  - 設定変更は最小限
  - エラー時の対応マニュアル必須

引き継ぎ:
  - ドキュメント完備
  - スクリーンショット必須
  - トラブルシューティングガイド
```

---

## 拡張計画

### フェーズ1（現在）: MVP

```yaml
機能:
  - 手動実行
  - 基本的なエラーハンドリング
  - 進捗表示

目標:
  - 週2本の安定投稿
  - ワークフロー確立
```

### フェーズ2（2-3ヶ月後）: 自動化

```yaml
機能:
  - RSS監視
  - スケジュール投稿
  - Slack通知

目標:
  - 完全自動化
  - 投稿頻度アップ
```

### フェーズ3（6ヶ月後）: 高度化

```yaml
機能:
  - 複数チャンネル対応
  - A/Bテスト
  - 分析ダッシュボード

目標:
  - 複数チャンネル展開
  - データドリブンな最適化
```

---

**最終更新**: 2025年11月15日
**次回レビュー**: MVP完成後
