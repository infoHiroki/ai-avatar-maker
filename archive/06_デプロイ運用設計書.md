# デプロイ・運用設計書

**プロジェクト名**: ブログ記事→YouTube動画自動生成システム
**バージョン**: 1.0.0
**作成日**: 2025年11月15日

---

## 📋 目次

1. [デプロイ戦略](#デプロイ戦略)
2. [環境構成](#環境構成)
3. [デプロイ手順](#デプロイ手順)
4. [監視・ログ](#監視ログ)
5. [運用手順](#運用手順)
6. [トラブルシューティング](#トラブルシューティング)

---

## デプロイ戦略

### デプロイ先

```yaml
Streamlit Community Cloud:
  - URL: https://share.streamlit.io/
  - 料金: 無料
  - リソース: 1GB RAM
  - 制約: 月間実行時間制限あり
  - メリット:
    - GitHub連携
    - 自動デプロイ
    - HTTPS自動設定
    - 無料
```

### デプロイフロー

```
ローカル開発
    ↓
    git commit & push
    ↓
GitHub Repository (main branch)
    ↓
    自動トリガー
    ↓
Streamlit Community Cloud
    ↓
    ビルド・デプロイ（2-3分）
    ↓
https://yourblog-to-youtube.streamlit.app
```

---

## 環境構成

### 開発環境

```yaml
目的: ローカル開発・テスト
実行方法:
  python -m venv venv
  source venv/bin/activate  # Windows: venv\Scripts\activate
  pip install -r requirements.txt
  streamlit run app.py

設定:
  - .streamlit/secrets.toml（ローカル）
  - .env（環境変数）
```

### ステージング環境（オプション）

```yaml
目的: 本番前テスト
ブランチ: staging
URL: https://yourblog-to-youtube-staging.streamlit.app

デプロイ方法:
  - GitHubのstagingブランチにpush
  - Streamlit Cloudで別アプリとして設定
```

### 本番環境

```yaml
目的: ユーザー向け提供
ブランチ: main
URL: https://yourblog-to-youtube.streamlit.app

デプロイ方法:
  - mainブランチにmerge/push
  - 自動デプロイ
```

---

## デプロイ手順

### 初回デプロイ

#### Step 1: GitHubリポジトリ作成

```bash
# ローカルでGit初期化
cd blog-to-youtube
git init
git add .
git commit -m "feat: 初回コミット

- Streamlit UIの実装
- 各APIモジュールの実装
- 設計ドキュメント追加

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# GitHubリポジトリ作成（Web UIまたはCLI）
gh repo create blog-to-youtube --private

# Push
git remote add origin https://github.com/your-username/blog-to-youtube.git
git branch -M main
git push -u origin main
```

#### Step 2: Streamlit Community Cloud設定

1. https://share.streamlit.io/ にアクセス
2. GitHubでサインイン
3. 「New app」をクリック
4. リポジトリ選択: `your-username/blog-to-youtube`
5. ブランチ: `main`
6. Main file path: `app.py`
7. 「Deploy!」をクリック

#### Step 3: Secrets設定

```
Streamlit Cloud Dashboard
  → App settings (歯車アイコン)
  → Secrets
  → Edit Secrets
```

```toml
# secrets.toml の内容をコピペ
[openai]
api_key = "sk-xxxxx"

[cartesia]
api_key = "cart_xxxxx"
voice_id = "voice_xxxxx"

[did]
api_key = "did_xxxxx"

[cloudinary]
cloud_name = "your_cloud"
api_key = "123456"
api_secret = "xxxxx"

[app]
password = "your_password"
```

「Save」をクリック

#### Step 4: デプロイ確認

- 数分待つ（ビルド・デプロイ）
- URLにアクセス: `https://your-app-name.streamlit.app`
- 動作確認

---

### 更新デプロイ

```bash
# コード修正
# ...

# コミット
git add .
git commit -m "fix: 音声生成のエラーハンドリング改善

- Cartesia WebSocketのタイムアウト処理追加
- リトライロジック実装

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# Push（自動デプロイ）
git push origin main

# デプロイ確認
# Streamlit Cloud Dashboardでログ確認
```

---

## 監視・ログ

### アプリケーションログ

#### ログ設定

```python
# utils/logger.py
import logging
import sys

def setup_logger(name: str) -> logging.Logger:
    """ロガーセットアップ"""
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)

    # コンソールハンドラー
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.INFO)

    # フォーマット
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    handler.setFormatter(formatter)

    logger.addHandler(handler)
    return logger
```

#### ログ出力

```python
logger = setup_logger(__name__)

# 情報ログ
logger.info("動画生成開始")

# 警告ログ
logger.warning("API使用量が80%に達しました")

# エラーログ
logger.error(f"動画生成失敗: {error}", exc_info=True)
```

#### Streamlit Cloudでのログ確認

```
Streamlit Cloud Dashboard
  → App
  → Manage app (三点アイコン)
  → Logs
```

### メトリクス監視

#### 使用量トラッキング

```python
# models/usage_tracker.py
from datetime import datetime
import json
import os

class UsageTracker:
    """API使用量トラッキング"""

    def __init__(self, file_path: str = "usage.json"):
        self.file_path = file_path
        self.load()

    def load(self):
        """使用量読み込み"""
        if os.path.exists(self.file_path):
            with open(self.file_path, "r") as f:
                self.data = json.load(f)
        else:
            self.data = {"month": datetime.now().strftime("%Y-%m"), "usage": {}}

    def track(self, service: str, amount: int):
        """使用量記録"""
        current_month = datetime.now().strftime("%Y-%m")

        # 月が変わったらリセット
        if self.data["month"] != current_month:
            self.data = {"month": current_month, "usage": {}}

        # 使用量加算
        if service not in self.data["usage"]:
            self.data["usage"][service] = 0
        self.data["usage"][service] += amount

        self.save()

    def save(self):
        """ファイル保存"""
        with open(self.file_path, "w") as f:
            json.dump(self.data, f)

    def get_usage(self, service: str) -> int:
        """使用量取得"""
        return self.data["usage"].get(service, 0)

# 使用例
tracker = UsageTracker()
tracker.track("cartesia_characters", len(script))

# 監視
if tracker.get_usage("cartesia_characters") > 80000:  # 80%
    logger.warning("Cartesia使用量が80%を超えました")
```

### エラー監視

```python
# エラーカウンター
error_count = 0

def handle_error(error: Exception):
    global error_count
    error_count += 1

    logger.error(f"エラー ({error_count}件目): {error}")

    # 閾値超過でアラート
    if error_count > 10:
        send_alert("エラーが10件を超えました")
```

---

## 運用手順

### 日常運用（非エンジニア向け）

#### 動画生成手順

```markdown
# 動画生成手順書

## 1. アプリにアクセス
https://yourblog-to-youtube.streamlit.app

## 2. ログイン（設定している場合）
パスワードを入力

## 3. ブログURLを入力
- 変換したいブログ記事のURLをコピー
- 「ブログ記事URL」欄に貼り付け

## 4. アバターを選択
- 好みのアバター画像をクリック

## 5. 動画生成開始
- 「▶️ 動画生成開始」ボタンをクリック
- 進捗を確認（5-10分かかります）

## 6. スクリプト確認
- 生成されたスクリプトを確認
- 必要に応じて編集
- 「✓ 確定」ボタンをクリック

## 7. プレビュー
- 動画が完成したらプレビュー
- 問題なければ次へ

## 8. YouTube投稿
- 「📺 YouTube投稿」ボタンをクリック
- YouTube URLが表示されたら完了

## トラブル時
- エラーが表示された場合は、スクリーンショットを撮影
- 管理者に連絡（email@example.com）
```

### 月次運用タスク

```yaml
月初（1日-5日）:
  ✅ API使用量確認
  ✅ コスト確認
  ✅ エラーログレビュー

月中（15日前後）:
  ✅ 使用量80%超過チェック
  ✅ パフォーマンス確認

月末（25日-末日）:
  ✅ 次月の計画確認
  ✅ 必要に応じてプラン変更
```

### 四半期タスク

```yaml
✅ APIキーのローテーション検討
✅ ユーザーフィードバック収集
✅ 機能改善の検討
✅ セキュリティレビュー
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. アプリにアクセスできない

**症状**: URLにアクセスしても表示されない

**原因と対処**:
```
- Streamlit Cloudのメンテナンス
  → https://status.streamlit.io/ で確認
  → 終了まで待機

- アプリがスリープ状態
  → 数秒待つと自動起動
  → 「App is starting...」が表示される

- デプロイ失敗
  → Streamlit Cloud Dashboardでログ確認
  → エラーを修正してre-deploy
```

#### 2. 動画生成が失敗する

**症状**: 「エラーが発生しました」と表示

**原因と対処**:
```
- API使用量超過
  → 使用量確認
  → 必要に応じてプラン変更

- APIキーが無効
  → Streamlit Secrets確認
  → APIキーを再発行

- ブログURLが無効
  → URLを確認
  → アクセス可能か確認
```

#### 3. 音声生成が遅い

**症状**: 音声生成に5分以上かかる

**原因と対処**:
```
- Cartesia API混雑
  → 時間を空けて再試行

- スクリプトが長すぎる
  → 文字数を確認（150単語以内推奨）
  → スクリプトを短縮
```

#### 4. YouTube投稿失敗

**症状**: 「YouTube投稿に失敗しました」

**原因と対処**:
```
- OAuth認証期限切れ
  → 再認証が必要
  → credentials.jsonを再設定

- クォータ超過
  → YouTube Data API クォータ確認
  → 翌日まで待機
```

### エラーコード一覧

| コード | 意味 | 対処 |
|--------|------|------|
| E001 | ChatGPT API エラー | APIキー確認 |
| E002 | Cartesia WebSocket エラー | 再接続を試行 |
| E003 | D-ID API エラー | 使用量・APIキー確認 |
| E004 | YouTube投稿エラー | OAuth再認証 |
| E005 | Cloudinaryエラー | 容量・認証情報確認 |

### ログの見方

```
# 正常ログ例
2025-01-15 10:00:00 - app - INFO - 動画生成開始
2025-01-15 10:00:05 - chatgpt - INFO - スクリプト生成完了
2025-01-15 10:02:00 - cartesia - INFO - 音声生成完了
2025-01-15 10:07:00 - did - INFO - 動画生成完了

# エラーログ例
2025-01-15 10:00:00 - cartesia - ERROR - WebSocket connection failed: [Errno 111] Connection refused
```

### サポート連絡先

```yaml
技術的な問題:
  担当: 開発者
  Email: dev@example.com

運用に関する問題:
  担当: 運用担当
  Email: ops@example.com

緊急時:
  Slack: #youtube-automation-support
```

---

## バックアップ・復旧

### バックアップ対象

```yaml
コード:
  - GitHubで自動バックアップ

設定:
  - secrets.toml（ローカル保存）
  - credentials.json（ローカル保存）

データ:
  - 生成した動画（YouTube保存）
  - 音声ファイル（Cloudinary保存）
```

### 復旧手順

#### 1. アプリクラッシュ時

```bash
# Streamlit Cloud Dashboard
→ Reboot app
```

#### 2. コード破損時

```bash
# Gitから復元
git checkout <commit-hash>
git push origin main --force
```

#### 3. 完全な再構築

```bash
# 1. リポジトリクローン
git clone https://github.com/your-username/blog-to-youtube.git

# 2. Streamlit Cloudで新規アプリ作成

# 3. Secrets再設定

# 4. デプロイ確認
```

---

**最終更新**: 2025年11月15日
**次回レビュー**: デプロイ後1週間
