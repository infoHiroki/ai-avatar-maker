# AIアバター動画生成システム - デプロイ記録

**日時**: 2025年11月15日
**作業内容**: Streamlit Cloudへのデプロイと各種バグ修正

---

## 📋 実施内容サマリー

### ✅ 完了した作業

1. **Streamlit Cloudデプロイ設定**
   - APIキーを`.streamlit/secrets.toml`に設定
   - リポジトリ名変更: `AIアバター` → `ai-avatar-maker`
   - Streamlit Cloudにデプロイ

2. **スクリプト長さ制限の改善**
   - 2段階バリデーション実装
   - リアルタイム文字数・時間表示（色分け）
   - 自動長さ判定（Shorts/Long選択を削除）

3. **Python 3.13互換性対応**
   - pydub → mutagen へ移行
   - WebSocket timeout パラメータ削除

4. **Cartesia API修正**
   - モデル名変更: `sonic-japanese` → `sonic-multilingual`
   - API仕様変更対応（単一メッセージ形式）
   - 音声フォーマット: `pcm_s16le` (16-bit)
   - 音質問題の解決

5. **D-ID統合修正**
   - CloudinaryでWAV→MP3自動変換
   - 変換完了待機機能追加（`eager_async=False`）

6. **UI改善**
   - ダークモード実装

---

## 🐛 発生した問題と解決策

### 問題1: pydub audioop モジュールエラー

**エラー内容**:
```
ModuleNotFoundError: import pyaudioop as audioop
```

**原因**: Python 3.13でaudioopモジュールが削除された

**解決策**:
- `requirements.txt`: `pydub` → `mutagen` に変更
- `cartesia.py`: mutagenを使用して音声時間を測定

**修正ファイル**:
- `requirements.txt`
- `src/modules/cartesia.py`

---

### 問題2: WebSocket timeout パラメータエラー

**エラー内容**:
```
BaseEventLoop.create_connection() got an unexpected keyword argument 'timeout'
```

**原因**: Python 3.13のwebsockets APIからtimeoutパラメータが削除

**解決策**:
- `websockets.connect(uri)` からtimeoutパラメータを削除

**修正ファイル**:
- `src/modules/cartesia.py` (line 110)

---

### 問題3: Cartesia API - containerフォーマットエラー

**エラー内容**:
```
only 'raw' container is supported for this endpoint
```

**原因**: WebSocket APIでは'mp3'コンテナ非対応

**解決策**:
```python
"output_format": {
    "container": "raw",
    "encoding": "pcm_s16le",
    "sample_rate": 44100
}
```

**修正ファイル**:
- `src/modules/cartesia.py` (lines 120-124)

---

### 問題4: Cartesia モデル名エラー

**エラー内容**:
```
model alias sonic-japanese is not supported for language ja
```

**原因**: Cartesiaがモデル名を変更

**解決策**:
- `sonic-japanese` → `sonic-multilingual`

**修正ファイル**:
- `config.yaml` (line 28)
- `src/modules/cartesia.py` (line 73)

---

### 問題5: Cartesia API メッセージ構造エラー

**エラー内容**:
```
invalid output specification: unsupported format
```

**原因**: APIが2メッセージ形式から単一メッセージ形式に変更

**解決策**:
初期化メッセージとテキストメッセージを統合：

```python
message = {
    "context_id": "temp",
    "model_id": self.model,
    "transcript": text,  # ここに統合
    "voice": {"mode": "id", "id": self.voice_id},
    "output_format": {...},
    "language": "ja",
    "continue": False,
    "_experimental_voice_controls": {"speed": speed}
}
```

**修正ファイル**:
- `src/modules/cartesia.py` (lines 112-130)

---

### 問題6: 音声品質問題（雑音・早送り）

**エラー内容**:
- 音声に激しい雑音
- 再生速度が異常に速い

**原因**:
- `pcm_f32le` (32-bit float) がPythonのwaveモジュールと非互換
- `setsampwidth(4)` が不適切

**解決策**:
```python
"encoding": "pcm_s16le",  # 16-bit signed integer

wav_file.setsampwidth(2)  # 16-bit = 2 bytes
```

**修正ファイル**:
- `src/modules/cartesia.py` (lines 122, 177)

**結果**: ✅ 雑音解消、正常な再生速度

---

### 問題7: D-ID API 500エラー

**エラー内容**:
```
動画生成リクエスト失敗 (Status: 500)
```

**原因**:
1. D-IDがMP3形式を期待しているがWAVファイルを送信
2. CloudinaryのWAV→MP3変換が完了する前にD-IDがアクセス

**解決策**:

#### Step 1: MP3形式への変換
```python
result = cloudinary.uploader.upload(
    audio_file_path,
    resource_type="video",
    format="mp3",  # WAVをMP3に自動変換
    ...
)
```

#### Step 2: 変換完了待機
```python
result = cloudinary.uploader.upload(
    audio_file_path,
    eager=[{"format": "mp3"}],  # 変換を強制実行
    eager_async=False  # 変換完了まで待機
    ...
)
```

**修正ファイル**:
- `src/modules/cartesia.py` (lines 231-241)

**状態**: 🟡 修正完了、テスト待ち

---

### 問題8: スクリプト長さ制限が厳しすぎる

**問題内容**:
- 初期実装: 150文字制限
- ユーザー: 「こんな制限あるんだったら全然使えないじゃないですか」

**解決策**:

#### 2段階バリデーション実装

**Stage 1: 推定時間チェック（音声生成前）**
- 最大: 350秒（約5分50秒）
- 目的: 明らかに長すぎるスクリプトをブロック
- 実装: `validator.py` - `validate_script()`

**Stage 2: 実測時間チェック（音声生成後）**
- 最大: 290秒（4分50秒）
- 目的: D-ID制限（5分）を厳守
- 実装: `app.py` - 音声生成後のチェック

#### リアルタイムUI フィードバック

```python
if char_count > max_chars:
    st.markdown(f"### :red[📝 文字数: {char_count} / {max_chars}]")
    st.error(f"⚠️ 推奨文字数を{char_count - max_chars}文字超過")
elif estimated_duration > 290:
    st.markdown(f"### :orange[⏱️ 予想時間: {minutes}分{seconds:02d}秒]")
    st.warning(f"⚠️ 5分に近いです（実測で確認されます）")
else:
    st.markdown(f"### :green[⏱️ 予想時間: {minutes}分{seconds:02d}秒]")
    st.success("✅ OK")
```

**修正ファイル**:
- `config.yaml` (lines 12-20)
- `src/modules/validator.py` (lines 73-83, 125-152)
- `app.py` (lines 90-120, 235-256)

**結果**: ✅ 柔軟な制限、ユーザーフレンドリー

---

## 🎨 UI改善

### ダークモード実装

**設定内容** (`.streamlit/config.toml`):
```toml
[theme]
base = "dark"
primaryColor = "#FF4B4B"
backgroundColor = "#0E1117"
secondaryBackgroundColor = "#262730"
textColor = "#FAFAFA"
font = "sans serif"
```

**修正ファイル**:
- `.streamlit/config.toml`

---

## 📊 最終的な処理フロー

```
1. ユーザー入力
   ↓
2. リアルタイム文字数・時間表示（緑/橙/赤）
   ↓
3. Stage 1: 推定時間チェック（350秒）
   ↓
4. Cartesia音声生成（pcm_s16le, WAV）
   ↓
5. mutagen で実測時間取得
   ↓
6. Cloudinary アップロード
   - WAV → MP3 変換
   - 変換完了まで待機 (eager_async=False)
   ↓
7. Stage 2: 実測時間チェック（290秒）
   ↓
8. D-ID 動画生成
   ↓
9. 完成！
```

---

## 🔧 主要な技術的決定

### 1. Python 3.13対応
- **pydub → mutagen**: 音声メタデータ取得
- **WebSocket API**: timeoutパラメータ削除

### 2. Cartesia API
- **モデル**: `sonic-multilingual`
- **フォーマット**: `raw/pcm_s16le/44100Hz`
- **メッセージ形式**: 単一メッセージ（統合形式）

### 3. 音声品質
- **エンコーディング**: pcm_s16le（16-bit signed integer）
- **サンプル幅**: 2バイト
- **チャンネル**: モノラル

### 4. Cloudinary統合
- **変換**: WAV → MP3（自動）
- **待機**: eager_async=False で変換完了を保証
- **フォーマット**: `format="mp3"`, `eager=[{"format": "mp3"}]`

### 5. バリデーション戦略
- **推定チェック**: 350秒（音声生成前）
- **実測チェック**: 290秒（音声生成後、動画生成前）
- **UI**: リアルタイム色分け表示

---

## 📁 修正されたファイル一覧

### 設定ファイル
- `config.yaml` - スクリプト制限、モデル名
- `.streamlit/config.toml` - ダークモード
- `requirements.txt` - mutagen追加

### ソースコード
- `src/modules/cartesia.py` - API修正、音声品質、Cloudinary
- `src/modules/validator.py` - 2段階バリデーション
- `app.py` - UI改善、実測時間チェック

---

## 🚀 現在のステータス

### ✅ 動作確認済み
- スクリプト入力・バリデーション
- リアルタイムフィードバック（色分け）
- Cartesia音声生成（17.8秒、雑音なし）
- Cloudinary MP3アップロード
- ダークモードUI

### 🟡 テスト待ち
- D-ID動画生成（Cloudinary MP3変換待機修正後）

### 📝 次のステップ
1. Streamlit Cloud 再デプロイ待機（1-2分）
2. エンドツーエンドテスト（スクリプト → 動画）
3. 動画品質確認
4. 本番運用開始

---

## 💡 学んだこと

### ベストプラクティス
1. **外部API連携**: 変換処理の完了を明示的に待つ（eager_async=False）
2. **バリデーション**: 推定値と実測値の2段階チェック
3. **エラーハンドリング**: 詳細なログ出力で原因特定を容易に
4. **Python互換性**: 最新版での破壊的変更に注意

### トラブルシューティングのポイント
- API仕様変更は公式ドキュメントとSDKコードを確認
- 音声フォーマットはエンコーディングとサンプル幅を正確に一致させる
- 外部サービス連携では処理完了のタイミングを慎重に制御

---

## 📞 参考情報

### API ドキュメント
- Cartesia: https://docs.cartesia.ai/
- D-ID: https://docs.d-id.com/
- Cloudinary: https://cloudinary.com/documentation/
- Streamlit: https://docs.streamlit.io/

### 関連ドキュメント
- `CLAUDE.md` - プロジェクト全体の記録
- `resources/Cartesia実装ガイド.md` - Cartesia実装の詳細
- `design/` - 設計ドキュメント

---

**作成日**: 2025年11月15日
**最終更新**: 2025年11月15日
**ステータス**: デプロイ完了、最終テスト待ち
